---
// Import necessary components and utilities
import MainLayout from "@/layouts/MainLayout.astro";
import AvatarBlogLarge from "@components/ui/avatars/AvatarBlogLarge.astro";
import CardRelated from "@components/ui/cards/CardRelated.astro";
import Bookmark from "@components/ui/buttons/Bookmark.astro";
import SocialShare from "@components/ui/buttons/SocialShare.astro";
import PostFeedback from "@components/ui/feedback/PostFeedback.astro";
import { Image } from "astro:assets";
import { capitalize, formatDate } from "@utils/utils";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

// getStaticPaths is used to pre-render all routes based on the blog posts
export async function getStaticPaths() {
  const blogPosts = await getCollection("blog", ({ id }) => {
    return id.startsWith("en/");
  });
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// Get the current post's data
const { post } = Astro.props;

// Get all blog posts
const blogPosts: CollectionEntry<"blog">[] = await getCollection(
  "blog",
  ({ id }) => {
    return id.startsWith("en/");
  }
);

// Filter out the current post to get related posts
const relatedPosts: CollectionEntry<"blog">[] = blogPosts.filter(
  (blogEntry) => blogEntry.slug !== post.slug
);

const pageTitle: string = `${post.data.title} | ${SITE.title}`;
---

<MainLayout title={pageTitle}>
  <section class="mx-auto max-w-screen-xl px-4 pb-12 pt-6 sm:px-6 lg:px-8 lg:pt-10">
    <div class="grid gap-8 md:grid-cols-3 relative">
      <div class="max-w-2xl md:col-span-2">
        <!-- Post Metadata -->
        <div class="mb-6 flex items-center justify-between">
          <div class="flex w-full gap-x-5 sm:items-center sm:gap-x-3">
            <div class="grow">
              <div class="flex items-center justify-between gap-x-2">
                <div>
                  <ul class="text-xs text-neutral-500">
                    <li class="relative inline-block pe-6 before:absolute before:end-2 before:top-1/2 before:size-1 before:-translate-y-1/2 before:rounded-full before:bg-neutral-300 last:pe-0 last-of-type:before:hidden dark:text-neutral-400 dark:before:bg-neutral-600">
                      {formatDate(post.data.pubDate)}
                    </li>
                    <li class="relative inline-block pe-6 before:absolute before:end-2 before:top-1/2 before:size-1 before:-translate-y-1/2 before:rounded-full before:bg-neutral-300 last:pe-0 last-of-type:before:hidden dark:text-neutral-400 dark:before:bg-neutral-600">
                      {post.data.readTime} min read
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Post Title -->
        <h2 class="mb-3 text-2xl font-bold text-neutral-800 dark:text-neutral-200 md:text-3xl">
          {post.data.title}
        </h2>

        <!-- Featured Image -->
        <Image
          class="w-full max-h-92 object-cover object-center my-6 rounded-xl"
          src={post.data.cardImage}
          alt={post.data.cardImageAlt}
          draggable={"false"}
          format={"avif"}
        />

        <!-- Post Content Blocks -->
        <div class="mb-5 space-y-5 md:mb-8 md:space-y-8">
          {post.data.contents.map((block) => {
            const customStyle = block.style || ""; // Use custom style if provided
            if (block.type === "text") {
              return <p class={`text-pretty text-lg text-neutral-700 dark:text-neutral-300 ${customStyle}`}>{block.value}</p>;
            } 
            else if (block.type === "image") {
              block.src && block.alt && (
                <figure class={customStyle}>
                  <Image
                    class="w-full object-cover object-center my-6 rounded-xl"
                    src={block.src}
                    alt={block.alt}
                    draggable={"false"}
                    format={"avif"}
                  />
                  <figcaption class="text-sm text-neutral-500 dark:text-neutral-400">{block.caption}</figcaption>
                </figure>
              );
            } 
            else if (block.type === "table") {
              return (
                <table class={`divide-y divide-neutral-300 dark:divide-neutral-700 ${customStyle}`}>
                  <thead>
                    <tr>
                      {block.headers?.map((header) => (
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider dark:text-neutral-400">{header}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {block.rows?.map((row) => (
                      <tr>
                        {row.map((cell) => (
                          <td class="px-6 py-4 text-sm text-neutral-700 dark:text-neutral-300">{cell}</td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              );
            }
          })}
        </div>

        <!-- Bookmark and Share Buttons -->
        <div class="mx-auto grid max-w-screen-lg gap-y-5 sm:flex sm:items-center sm:justify-between sm:gap-y-0">
          <div class="flex items-center justify-end gap-x-1.5">
            <div class="inline-flex">
              <SocialShare pageTitle={post.data.title} />
            </div>
          </div>
        </div>
      </div>

      <div class="sticky" id="progress-mobile">
        <div class="overflow-hidden rounded-lg bg-neutral-100 dark:bg-neutral-900 md:max-w-96 p-4 space-y-6 shadow-xl">
          <h4 class="text-pretty text-lg text-neutral-700 dark:text-neutral-300">Suggested Offer:</h4>
          <Image
            class="h-full w-full object-cover object-center"
            src={post.data.cardImage}
            alt={post.data.cardImageAlt}
            draggable={"false"}
            format={"avif"}
          />
          <h4 class="text-pretty text-lg text-neutral-700 dark:text-neutral-300">Suggested Article:</h4>
          <Image
            class="h-full w-full object-cover object-center"
            src={post.data.cardImage}
            alt={post.data.cardImageAlt}
            draggable={"false"}
            format={"avif"}
          />
        </div>
      </div>
    </div>
  </section>

  <!-- Related Articles Section -->
  <section class="mx-auto max-w-3xl px-4 py-10 sm:px-6 lg:px-8 lg:py-14">
    <div class="mb-10 max-w-2xl">
      <h2 class="text-balance text-2xl font-bold text-neutral-800 dark:text-neutral-200 md:text-4xl md:leading-tight">
        Related articles
      </h2>
    </div>
    <div class="grid grid-cols-2 gap-6">
      {relatedPosts.map((entry) => <CardRelated blogEntry={entry} />)}
    </div>
  </section>
</MainLayout>
